name: Validate Plugins

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  validate:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Claude Code CLI
        run: npm install -g @anthropic-ai/claude-code

      - name: Validate marketplace.json
        run: |
          echo "Validating marketplace configuration..."
          if [ ! -f ".claude-plugin/marketplace.json" ]; then
            echo "ERROR: marketplace.json not found"
            exit 1
          fi

          # Validate JSON syntax
          cat .claude-plugin/marketplace.json | python3 -m json.tool > /dev/null
          echo "✅ marketplace.json is valid JSON"

      - name: Validate plugin structures
        run: |
          echo "Validating plugin structures..."

          for plugin_dir in plugins/*/; do
            plugin_name=$(basename "$plugin_dir")
            echo "Checking plugin: $plugin_name"

            # Check plugin.json exists
            if [ ! -f "$plugin_dir/.claude-plugin/plugin.json" ]; then
              echo "ERROR: $plugin_name missing plugin.json"
              exit 1
            fi

            # Validate JSON syntax
            cat "$plugin_dir/.claude-plugin/plugin.json" | python3 -m json.tool > /dev/null
            echo "  ✅ plugin.json is valid"

            # Check for commands or agents
            if [ ! -d "$plugin_dir/commands" ] && [ ! -d "$plugin_dir/agents" ]; then
              echo "  ⚠️ Warning: No commands or agents directory"
            fi

            echo "  ✅ $plugin_name structure valid"
          done

          echo "✅ All plugins validated"

      - name: Check markdown files
        run: |
          echo "Checking markdown files..."

          # Find all markdown files and check for basic validity
          find . -name "*.md" -type f | while read -r file; do
            # Check file is not empty
            if [ ! -s "$file" ]; then
              echo "WARNING: Empty file: $file"
            fi
          done

          echo "✅ Markdown files checked"

      - name: Summary
        run: |
          echo ""
          echo "=== Plugin Marketplace Validation Summary ==="
          echo ""
          echo "Plugins found:"
          ls -1 plugins/ | while read -r plugin; do
            echo "  - $plugin"
          done
          echo ""
          echo "✅ All validations passed!"
